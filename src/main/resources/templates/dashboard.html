<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Report Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            background-color: #1e1e2f;
            color: #fff;
        }

        #sidebar {
            width: 300px;
            min-width: 200px;
            max-width: 400px;
            background-color: #2a1f3c;
            /* darker purple */
            padding: 15px;
            overflow-y: auto;
            resize: horizontal;
            border-right: 4px solid #9b59b6;
            /* prominent bright purple */
        }

        #sidebar h2 {
            color: #e0c3ff;
            /* brighter purple for title */
            margin-bottom: 20px;
            text-align: center;
        }

        #sidebar h3 {
            color: #d8b3ff;
            /* slightly lighter purple for section headings */
            margin-top: 20px;
            margin-bottom: 5px;
        }

        #sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0 0 10px 0;
        }

        #sidebar li {
            padding: 6px 8px;
            margin-bottom: 5px;
            background-color: #3b2a5f;
            /* dark purple background */
            border-left: 4px solid #9b59b6;
            /* strong accent */
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #sidebar li:hover {
            background-color: #7f5ccf;
            /* bright purple on hover */
        }

        #map {
            flex: 1;
        }

        .popup-button {
            margin-top: 5px;
            padding: 5px 10px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            color: white;
        }

        .delete-btn {
            background: #e74c3c;
        }

        .help-btn {
            background: #3498db;
        }

        .help-label {
            color: #2ecc71;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Scrollbar for sidebar */
        #sidebar::-webkit-scrollbar {
            width: 10px;
        }

        #sidebar::-webkit-scrollbar-track {
            background: #2a1f3c;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background-color: #9b59b6;
            border-radius: 5px;
        }
    </style>

</head>

<body>
    <div id="sidebar">
        <h2>Active Reports</h2>
        <!-- Report lists will be injected here -->
        <div id="reportLists"></div>
    </div>

    <div id="map"></div>

    <script>
        const map = L.map('map').setView([14.5995, 120.9842], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const colors = {
            ROAD_CONDITION: 'green',
            HAZARD: 'red',
            POI: 'blue',
            NEED_AID: 'orange'
        };

        const typeLabels = {
            ROAD_CONDITION: "Road Condition",
            HAZARD: "Hazard",
            POI: "Point of Interest",
            NEED_AID: "Need Assistance"
        };

        let activeMarkers = [];
        let reportsData = [];

        async function loadReports() {
            try {
                // Remove old markers
                activeMarkers.forEach(marker => map.removeLayer(marker));
                activeMarkers = [];

                const response = await fetch('/api/reports');
                const reports = await response.json();
                reportsData = reports; // store for sidebar
                renderSidebar();

                reports.forEach(report => {
                    const marker = L.circleMarker([report.latitude, report.longitude], {
                        radius: 8,
                        color: colors[report.type] || 'gray',
                        fillColor: colors[report.type] || 'gray',
                        fillOpacity: 0.8
                    }).addTo(map);

                    activeMarkers.push(marker);

                    let popupContent = `
                        <strong>Type:</strong> ${typeLabels[report.type] || report.type}<br>
                        <strong>Description:</strong> ${report.description || ''}<br>
                        <strong>Time:</strong> ${new Date(report.timestamp).toLocaleString()}<br><br>
                        <button class="popup-button delete-btn" onclick="deleteReport(${report.id})">Delete</button>
                    `;

                    if (report.type === "NEED_AID") {
                        if (report.helpOnTheWay) {
                            popupContent += `<div class="help-label">Someone is coming to help!</div>`;
                        } else {
                            popupContent += `<button class="popup-button help-btn" onclick="helpOnTheWay(${report.id})">I'm on my way</button>`;
                        }
                    }

                    marker.bindPopup(popupContent);
                });

            } catch (error) {
                console.error("Failed to load reports:", error);
            }
        }

        function renderSidebar() {
            const container = document.getElementById("reportLists");
            container.innerHTML = "";

            const types = Object.keys(typeLabels);
            types.forEach(type => {
                const filtered = reportsData.filter(r => r.type === type);
                if (filtered.length > 0) {
                    const h3 = document.createElement("h3");
                    h3.textContent = typeLabels[type];
                    container.appendChild(h3);

                    const ul = document.createElement("ul");
                    filtered.forEach(report => {
                        const li = document.createElement("li");
                        li.textContent = report.description || `Report #${report.id}`;
                        li.addEventListener("click", () => {
                            map.setView([report.latitude, report.longitude], 16);
                            activeMarkers.find(m => m.getLatLng().lat === report.latitude && m.getLatLng().lng === report.longitude)?.openPopup();
                        });
                        ul.appendChild(li);
                    });
                    container.appendChild(ul);
                }
            });
        }

        async function deleteReport(id) {
            try {
                const res = await fetch(`/api/reports/${id}`, { method: "DELETE" });
                if (res.ok) {
                    loadReports();
                } else {
                    alert("Failed to delete");
                }
            } catch (err) {
                console.error(err);
                alert("Error deleting report.");
            }
        }

        async function helpOnTheWay(id) {
            try {
                const res = await fetch(`/api/reports/${id}/help`, { method: "POST" });
                if (res.ok) {
                    loadReports();
                } else {
                    alert("Failed to mark help on the way.");
                }
            } catch (err) {
                console.error(err);
                alert("Error occurred.");
            }
        }

        loadReports();
        setInterval(loadReports, 7000);
    </script>
</body>

</html>